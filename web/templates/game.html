{% extends "base.html" %}

{% block headscripts %}
<link rel="stylesheet" type="text/css" href="/static/css/slick.css"/>
<link rel="stylesheet" type="text/css" href="/static/css/slick-theme.css"/>
{% endblock %}

{% block top_nav_bar_right %}
    <li><a href="/rooms">Rooms</a></li>
    <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">{{nickname}} <span class="caret"></span></a>
        <ul class="dropdown-menu">
            <li><a href="/logout">Logout</a></li>
        </ul>
    </li>
{% endblock %}

{% block content %}
<div class="jumbotron">
    <div class="row">
        <div class="col-md-6">
            <canvas id='src' height='400' style='width: 90%; border: 1px solid black'></canvas>
        </div>
        <div id="imageArea" class="col-md-6">
        </div>
    </div>
</div>
{% endblock %}

{% block onload %}
<script type="text/javascript" src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
<script type="text/javascript" src='/static/js/sketch.js'></script>
<script type="text/javascript" src="/static/js/slick.js"></script>
<script type="text/javascript">
    var me;
    var connections = {};

    function onClose(event) {
        console.log("connection closed");
    }

    function onMessage(event) {
        var data = JSON.parse(event.data);
        if(data["kind"] === "drawing"){
            var image = $("#image-"+data["nickname"]);
            image.attr("src", data["data"]);
        } else if (data["kind"] === "newConn") {
            if(data["nickname"] == "{{nickname}}"){
                return;
            }
            var c = new WebSocket("ws://"+data["ip"]+":8000/ws");
            c.onclose = onClose;
            c.onmessage = onMessage;
            connections[data["nickname"]] = {"ip": data["ip"], "conn": c};

            var form = '<form class="form-inline">'+
                            '<div class="form-group has-success">'+
                                '<div class="input-group">'+
                                    '<span class="input-group-addon">@'+data["nickname"]+'</span>' +
                                    '<input type="text" class="form-control" id="input-'+data["nickname"]+'" aria-describedby="inputGroupSuccess1Status">' +
                                '</div>'+
                            '</div>'+
                            '<button type="submit" class="btn btn-default">Guess</button>'+
                        '</form>';
            var image = '<img id="image-'+data["nickname"]+'" src="" height="400" style="width: 100%; border: 1px solid black"></img>';
            var html = '<div>' + image + ' ' + form + '</div>';
            $("#imageArea").slick('slickAdd', html);
        }
    }

    $(function() {
        var maxPlayers = {{maxPlayers}};
        if(("{{nickname}}" === "")) {
            window.location.href = "/login";
        }
        $('#src').sketch();
        $('#imageArea').slick({
            slidesToShow: 1,
            slidesToScroll: 1,
            accessibility: true,
            prevArrow: '<button type="button" class="slick-prev">Previous</button>',
            nextArrow: '<button type="button" class="slick-next">Next</button>'
        });

        $("#src").on("mouseup", function(e) {
            var data = $('#src').get(0).toDataURL();
            var jsonData = {"kind": "drawing", "nickname": "{{nickname}}", "data": data};
            me.send(JSON.stringify(jsonData));
        });

        $.get("{{dns}}/peers/{{roomID}}", function(data){
            console.log(data);
            if (!window["WebSocket"]) {
                alert("Your browser does not support WebSockets. Ending Game");
                window.location.href = "/logout";
                return;
            }
            for(var i=0; i<data.length; i++){
                if("{{playerIP}}" === data[i][2]){
                    me = new WebSocket("ws://"+data[i][2]+":8000/ws");
                    me.onclose = onClose;
                    me.onmessage = onMessage;
                } else {
                    var c = new WebSocket("ws://"+data[i][2]+":8000/ws");
                    c.onclose = onClose;
                    c.onmessage = onMessage;
                    c.onopen = function(event){
                        var newConnMsg = {"kind": "newConn", "ip": "{{playerIP}}", "nickname": "{{nickname}}"};
                        c.send(JSON.stringify(newConnMsg));
                    }
                    connections[data[i][1]] = {"ip": data[i][2], "conn": c};
                    var form = '<form class="form-inline">'+
                                    '<div class="form-group has-success">'+
                                        '<div class="input-group">'+
                                            '<span class="input-group-addon">@'+data[i][1]+'</span>' +
                                            '<input type="text" class="form-control" id="input-'+data[i][1]+'" aria-describedby="inputGroupSuccess1Status">' +
                                        '</div>'+
                                    '</div>'+
                                    '<button type="submit" class="btn btn-default">Guess</button>'+
                                '</form>';
                    var image = '<img id="image-'+data[i][1]+'" src="" height="400" style="width: 100%; border: 1px solid black"></img>';
                    var html = '<div>' + image + ' ' + form + '</div>';
                    $("#imageArea").slick('slickAdd', html);
                }
            }
        }, "json");
    });


</script>
{% endblock %}
